#Include "MathLib" as MathLib
#Include "TextLib" as TextLib

#Include "Libs/BigBang1112/Http.Script.txt" as Http
#Include "Libs/BigBang1112/Layers.Script.txt" as Layers
#Include "Libs/BigBang1112/Manialink.Script.txt" as Manialink
#Include "Libs/BigBang1112/Settings.Script.txt" as Settings
#Include "Libs/BigBang1112/File.Script.txt" as File
#Include "Libs/BigBang1112/Dictionary.Script.txt" as Dictionary
#Include "Libs/BigBang1112/Map.Script.txt" as Map

#Include "Libs/Challenge/Vehicle.Script.txt" as Vehicle
#Include "Libs/Challenge/Loading.Script.txt" as Loading

#Include "Libs/Challenge/Service/Status.Script.txt" as Service_Status

#Include "Libs/Maker/MakerBase.Script.txt" as MakerBase

#Struct SMetadata {
	Text Name;
	Text AuthorLogin;
	Text AuthorNickname;
	Text Description;
	Text CompatibleCollections;
}

#Struct SScriptInfo {
	Text Name;
	Text Type;
	SMetadata Metadata;
}

#Struct SChallenge {
	Text Name;
	Text Type;
}

#Struct SRecord {
	Text Login;
	Text Nickname;
	Integer Time;
	Real Distance;
	Integer Stunts;
	Text Driven;
}

Void UpdateChallenges() {
	declare SChallenge[][] Challenges for This;
	declare SScriptInfo[][] Scripts_Campaign for Layers::Page("Campaign");
	declare SScriptInfo[][] Scripts_MapMenu for Layers::Page("MapMenu");
	Scripts_Campaign.clear();
	Scripts_MapMenu.clear();
	
	foreach(Challenge, Challenges) {
		declare SScriptInfo[] ChallengeScripts;
		foreach(SubChallenge, Challenge) {
			ChallengeScripts.add(MakerBase::SChallengeToSScriptInfo(SubChallenge));
		}
		Scripts_Campaign.add(ChallengeScripts);
		Scripts_MapMenu.add(ChallengeScripts);
	}
}

Void Init() {
	Layers::Create("Campaign", "");
	//MakerBase::UpdateBuilder("Campaign", "Media/Manialinks/Campaign/Campaign", 0, 0, False, []);
	yield;
	Layers::Create("MapMenu", Manialink::FromFile("Media/Manialinks/Campaign/MapMenu", True, ["Audio","SlideText"], Settings::Get().Theme));
	
	declare Vehicle::SVehicle[] Vehicles for This;
	Vehicles = Vehicle::FromFile("Media/Vehicle.json");
	declare Text[] Cars for Layers::Page("MapMenu");
	foreach(Vehicle,Vehicles) Cars.add(Vehicle.Name);
	
	UpdateChallenges();
	declare SScriptInfo[][] Scripts_Campaign for Layers::Page("Campaign");
	MakerBase::UpdateBuilder("Campaign", "Media/Manialinks/Campaign/Campaign", 0, 0, False, MakerBase::ChallengesToTextArray(Scripts_Campaign));
}

Void Start() {
	
}

declare Text MapFileToStart;

Void Event(CManiaAppEvent _Event) {
	declare Event <=> _Event;

	if(Event.Type == CManiaAppEvent::EType::LayerCustomEvent) {
		switch(Event.CustomEventLayer) {
			case Layers::Get("Campaign"): {
				switch(Event.CustomEventType) {
					case "Exit": {
						Layers::Hide("Campaign", False);
						Layers::Show("EditTitle", True);
						Layers::Show("ManageTitle", True);
					}
					case "Map": {
						Layers::Show("MapMenu", True);
						
						declare Vehicle::SVehicle[] Vehicles for This;
						declare Text[] VehicleNames;
						
						foreach(Vehicle,Vehicles) {
							VehicleNames.add(Vehicle.Name);
						}
						
						declare Success = Http::AsyncGET("VALIDATION", """{{{Service_Status::LastStatus(LocalUser).Global.Service}}}/validation.php?uid={{{Event.CustomEventData[2]}}}&car={{{TextLib::Join(",",VehicleNames)}}}""");
						declare Success2 = Http::AsyncGET("RECORDS", """{{{Service_Status::LastStatus(LocalUser).Global.Service}}}/records.php?uid={{{Event.CustomEventData[2]}}}&car={{{TextLib::Join(",",VehicleNames)}}}&zone=World""");
						
						declare Text[] Data;
						foreach(D,Event.CustomEventData) Data.add(D);
						Layers::SendEvent("MapMenu", "Map", Data);
					}
				}
			}
			case Layers::Get("MapMenu"): {
				switch(Event.CustomEventType) {
					case "Start": {
						declare FileName = Event.CustomEventData[0];
						MapFileToStart = FileName;
					}
					case "Exit": {
						Layers::Hide("MapMenu");
					}
				}
			}
		}
	}
}

Void Async() {
	if(Http::IsCompleted("VALIDATION")) {
		if(Http::IsSuccessful("VALIDATION")) {
			declare SRecord[Text] Validations for Layers::Page("MapMenu");
			declare Success = Validations.fromjson(Http::GetResult("VALIDATION"));
			
			Layers::SendEvent("MapMenu", "Validation");
		}
		else {
			
		}
		Http::Destroy("VALIDATION");
	}
	if(Http::IsCompleted("RECORDS")) {
		if(Http::IsSuccessful("RECORDS")) {
			declare SRecord[][Text] Records for Layers::Page("MapMenu");
			declare Success = Records.fromjson(Http::GetResult("RECORDS"));
			
			Layers::SendEvent("MapMenu", "Records");
		}
		else {
			
		}
		Http::Destroy("RECORDS");
	}
}

Void Loop() {
	declare Boolean IsReloaded for This;
	declare Boolean IsUpdating for Layers::Page("Campaign");
	if(IsUpdating) {
		if(!IsReloaded) {
			declare SScriptInfo[][] Scripts_Campaign for Layers::Page("Campaign");
			
			MakerBase::UpdateBuilder("Campaign", "Media/Manialinks/Campaign/Campaign", 0, 0, False, MakerBase::ChallengesToTextArray(Scripts_Campaign));
			IsReloaded = True;
		}
		IsUpdating = False;
	}
	if(MapFileToStart != "") {
		declare Map = Map::MapInfo(MapFileToStart);
		Loading::SetLoading(Map.CollectionName, Map);
		wait(TitleControl.IsReady);
		TitleControl.PlayMap(MapFileToStart, "Modes/TrackMania/ChallengeSolo.Script.txt", "");
			
		Layers::Hide("MapMenu");
		MapFileToStart = "";
	}
}